language: java
jdk: openjdk8
dist: trusty
sudo: required
before_install:
  - unset _JAVA_OPTIONS
env:
  global:
    - GRADLE_OPTS='-Xmx256m'
    - BUILD_CACHE_DIR="$HOME/build-cache"
    - TESTS_FILE_NAME="$TRAVIS_BUILD_DIR/tests.txt"
    - TESTS_FILES_PREFIX='tests'
    - OP_VERSION_PROPS_DISABLED=true
install:
  - true
after_success:
  - bash <(curl -s https://codecov.io/bash)
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
  - mkdir -p $BUILD_CACHE_DIR
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $BUILD_CACHE_DIR
jobs:
  include:
    - stage: 'clone repo and compile project'
      name: 'Clone repo & compile project'
      script: |
        find **/src/test/scala/* -type f -name '*.scala' | cut -d "/" -f5-$2 | sed 's/.\{6\}$/\*/g' > $TESTS_FILE_NAME
        TOTAL_TESTS=`cat $TESTS_FILE_NAME | wc -l`
        pushd $BUILD_CACHE_DIR
        echo 'Removing any old cached test files'
        rm -vf "$TESTS_FILES_PREFIX"*
        echo 'Splitting test files into following parts'
        split --numeric-suffixes -l `echo "($TOTAL_TESTS/4)+1" | bc` $TESTS_FILE_NAME $TESTS_FILES_PREFIX
        ls "$TESTS_FILES_PREFIX"* | sort | xargs wc -l
        sed -i 's/\\n$//g' "$TESTS_FILES_PREFIX"*
        popd
        ./gradlew testScoverageClasses --parallel
    - script: ./gradlew scalaStyle --parallel
      name: 'Scala style check'
    - stage: 'build'
      name: 'Build Part 1'
      script: |
        export TEST_FILES=`cat "$BUILD_CACHE_DIR/$TESTS_FILES_PREFIX"00`
        ./gradlew --no-daemon reportScoverage
    - script: |
        export TEST_FILES=`cat "$BUILD_CACHE_DIR/$TESTS_FILES_PREFIX"01`
        ./gradlew --no-daemon reportScoverage
      name: 'Build Part 2'
    - script: |
        export TEST_FILES=`cat "$BUILD_CACHE_DIR/$TESTS_FILES_PREFIX"02`
        ./gradlew --no-daemon reportScoverage
      name: 'Build Part 3'
    - script: |
        export TEST_FILES=`cat "$BUILD_CACHE_DIR/$TESTS_FILES_PREFIX"03`
        ./gradlew --no-daemon reportScoverage
      name: 'Build Part 4'
